# CI Pipeline for Cinephoria Cinema Booking Application
# Runs tests and performs code quality checks
name: CI Pipeline

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create test environment file
      run: |
        mkdir -p server
        cat > server/.test.env << EOF
        NODE_ENV=test
        MYSQL_HOST=mysql_test
        MYSQL_USER=root
        MYSQL_PASSWORD=5599
        MYSQL_DATABASE=cinephoria_test
        REDIS_HOST=redis_test
        ACCESS_JWT_SECRET=test_access_jwt_secret_for_ci_only
        REFRESH_JWT_SECRET=test_refresh_jwt_secret_for_ci_only
        EMAIL_VERIFICATION_SECRET=test_email_verification_secret_for_ci_only
        PASSWORD_RESET_SECRET=test_password_reset_secret_for_ci_only
        SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
        S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
        S3_BUCKET_REGION=${{ secrets.S3_BUCKET_REGION }}
        S3_BUCKET_ACCES_KEY=${{ secrets.S3_BUCKET_ACCES_KEY }}
        S3_BUCKET_SECRET_ACCES_KEY=${{ secrets.S3_BUCKET_SECRET_ACCES_KEY }}
        FRONTEND_URL=http://localhost:3000
        EOF
        
    - name: Run tests
      run: |
        docker-compose -f Docker-compose.test.yaml up --abort-on-container-exit
        
    - name: Clean up
      if: always()
      run: |
        docker-compose -f Docker-compose.test.yaml down -v